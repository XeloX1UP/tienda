---
import { listaProductos, valorAPesosChilenos } from "../../assets/exports";
import Calificacion from "../../components/store/Calificacion.astro";
import Vitrina from "../../components/store/Vitrina.astro";
import Layout from "../../layouts/Layout.astro";

export const prerender = false;
const { id } = Astro.params;
const producto = listaProductos.find(p => p.id.toString() === id);
if (!producto) {
    return Astro.redirect('/404');
}

// Crear lista de todas las imágenes (principal + adicionales)
const todasLasImagenes = [producto.imageSrc, ...(producto.additionalImages || [])];
const rnd = Math.random().toString(36).slice(2,9);
---

<Layout title={producto.productName}>
    <product-page class="text-center" id={rnd} data-product-id={id}>
        <h2 class="text-3xl md:text-4xl font-bold" transition:name={`productName${id}`}>{producto.productName}</h2>
        
        <!-- Galería de imágenes -->
        <div class="relative w-80 aspect-square mx-auto mt-4 rounded-md shadow-lg overflow-hidden bg-bg-200/20">
            <div class="relative w-full h-full" data-galleryLength={todasLasImagenes.length}>
                {todasLasImagenes.map((imagen, index) => (
                    <img  
                        src={imagen} 
                        alt={`${producto.productName} - Imagen ${index + 1}`}
                        class={`absolute w-full h-full object-cover transition-opacity duration-500 ${index === 0 ? 'opacity-100' : 'opacity-0'}`}
                        data-image-index={index}
                        transition:name={index === 0 ? `productImage${id}` : undefined}
                    />
                ))}
            </div>

            <!-- Botones de navegación (solo si hay múltiples imágenes) -->
            {todasLasImagenes.length > 1 && (
                <>
                    <button 
                        id="prevBtn" 
                        class="absolute cursor-pointer left-2 top-1/2 -translate-y-1/2 bg-black/50 hover:bg-black/70 text-white p-2 rounded-full z-10 transition-colors"
                        aria-label="Imagen anterior"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                    </button>
                    <button 
                        id="nextBtn" 
                        class="absolute cursor-pointer right-2 top-1/2 -translate-y-1/2 bg-black/50 hover:bg-black/70 text-white p-2 rounded-full z-10 transition-colors"
                        aria-label="Siguiente imagen"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </button>

                    <!-- Indicadores de imagen -->
                    <div class="absolute bottom-2 left-1/2 -translate-x-1/2 flex gap-1 z-10">
                        {todasLasImagenes.map((_, index) => (
                            <button
                                class={`selector-btn w-2 h-2 rounded-full transition-all ${index === 0 ? 'bg-white w-6' : 'bg-white/50'}`}
                                data-dot-index={index}
                                aria-label={`Ver imagen ${index + 1}`}
                            />
                        ))}
                    </div>
                </>
            )}
        </div>

        <div class="">
            <Calificacion estrellas={producto.stars ?? 0} />
        </div>
        <div class="mt-4 bg-bg-200/20 p-4 text-left sm:text-lg md:text-xl rounded-md shadow whitespace-pre-wrap">
            <p class="mx-auto max-w-[600px]">{producto.description}</p>
        </div>
        <div>
            <p id="valor" class="mt-4 text-2xl sm:text-3xl font-semibold"
            transition:name={`productPrice${id}`}
            >Valor: {valorAPesosChilenos(producto.price)}</p>
        </div>
        <div class="container mx-auto ">
            <p class="italic text-text-200 sm:text-lg">Stock disponible</p>

            <!-- reemplazado: mostrar tallas como chips seleccionables -->
            {producto.size && (
                <div class="my-6" data-has-sizes="true">

                    <div id="sizeSelector" class="flex flex-wrap gap-2 justify-center">
                        {producto.size.map((s, idx) => (
                            <button
                                type="button"
                                class={`size-chip cursor-pointer inline-flex items-center justify-center px-3 py-1.5 rounded-full border transition-all text-sm ${idx === 0 ? 'bg-accent-100 text-bg-100 border-accent-100' : 'bg-bg-200/50 text-text-200 border-bg-300 hover:bg-accent-50 hover:border-accent-100'}`}
                                data-size={s}
                                aria-pressed={idx === 0 ? 'true' : 'false'}
                            >
                                {s}
                            </button>
                        ))}
                    </div>

                    <!-- valor por defecto (se actualiza en cliente) -->
                    <input type="hidden" name="selectedSize" id="selectedSize" value={producto.size[0]} />
                </div>
            )}
            <div class="flex justify-evenly items-center mt-3">
                <select name="cantidad" id="cantidad" class="border border-bg-300 rounded-md p-2 shadow-md hover:shadow-lg sm:text-xl md:text-2xl">
                    {Array.from({ length: producto.stock ?? 0 >= 10 ? 10 : producto.stock ?? 0 }, (_, i) => i + 1).map(cantidad => (
                        <option value={cantidad}>{cantidad} u.</option>
                    ))}
                </select>
                <p id="valorPorCantidad" class="sm:text-lg md:text-xl">Total: <span id="valorSpan" class="text-lg sm:text-xl md:text-2xl font-black">{valorAPesosChilenos(producto.price)}</span></p>
            </div>
        </div>
        <div>
            <button class="mt-4 bg-primary-200 hover:bg-primary-200/90 border border-primary-200 text-bg-100 py-2 sm:py-3 md:py-5 px-4 rounded-md shadow hover:shadow-lg active:scale-95 w-full text-xl sm:text-2xl font-bold" id="addToCartBtn">
                Agregar al carro
            </button>
        </div>
        <div>
            <Vitrina filterId={id} horizontal compact/>
        </div>
    </product-page>
    
</Layout>


<script define:vars={{id: rnd}}>
(function () {
  const fmtCLP = (v) => new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' }).format(v);

  function initProductPage(el) {
    if (!el) return;


    // -----------------------
    // Selector de cantidad / precio total
    // -----------------------
    const select = el.querySelector('#cantidad');
    const valorSpan = el.querySelector('#valorSpan');
    const valorNode = el.querySelector('#valor');

    const precioText = valorNode.textContent || '';
    const match = precioText.match(/\$[\d.,]+/);
    const precioUnitario = match ? parseInt(match[0].replace(/\D/g, ''), 10) : 0;

    const qtyHandler = () => {
      const q = parseInt(select.value || '0', 10);
      if (valorSpan) valorSpan.textContent = fmtCLP(precioUnitario * q);
    };

    if (select) {
      select.addEventListener('change', qtyHandler);
      // valor inicial
      qtyHandler();
    }

    // -----------------------
    // Selector de tallas (chips)
    // -----------------------
    const sizeBtns = Array.from(el.querySelectorAll('.size-chip'));
    const hidden = el.querySelector('#selectedSize');

    sizeBtns.map((btn) => {
      const fn = () => {
        sizeBtns.forEach((b) => {
          b.classList.remove('bg-accent-100', 'text-bg-100', 'border-accent-100');
          b.classList.add('bg-bg-200/50', 'text-text-200');
          b.setAttribute('aria-pressed', 'false');
        });
        btn.classList.add('bg-accent-100', 'text-bg-100', 'border-accent-100');
        btn.classList.remove('bg-bg-200/50', 'text-text-200');
        btn.setAttribute('aria-pressed', 'true');
        if (hidden) hidden.value = btn.dataset.size || '';
        
      };
      btn.addEventListener('click', fn);
      return { btn, fn };
    });
    
    // accesibilidad teclado
    const sizeContainer = el.querySelector('#sizeSelector');
    const sizeKeyHandler = (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        const active = document.activeElement;
        if (active && active.classList && active.classList.contains('size-chip')) {
          e.preventDefault();
          active.click();
        }
      }
    };
    if (sizeContainer) sizeContainer.addEventListener('keydown', sizeKeyHandler);

    // -----------------------
    // Selector imágenes
    // -----------------------
    const galleryDiv = el.querySelector('[data-galleryLength]');
    if (!galleryDiv) return;
    const images = Array.from(galleryDiv.querySelectorAll('img'));
    const totalImages = images.length;
    let currentIndex = 0;
    const showImageAtIndex = (index) => {
        images.forEach((img, idx) => {
            if (idx === index) {
                img.classList.remove('opacity-0');
                img.classList.add('opacity-100');
            } else {
                img.classList.remove('opacity-100');
                img.classList.add('opacity-0');
            }
        });
        // actualizar indicadores
        const dots = el.querySelectorAll('button[data-dot-index]');
        dots.forEach((dot, idx) => {
            if (idx === index) {
            dot.classList.add('bg-white', 'w-6');
            dot.classList.remove('bg-white/50');
            } else {
            dot.classList.remove('bg-white', 'w-6');
            dot.classList.add('bg-white/50');
            }
        });
    };
    
    const prevBtn = el.querySelector('#prevBtn');
    const nextBtn = el.querySelector('#nextBtn');
    if (prevBtn) {
      prevBtn.addEventListener('click', () => {
        currentIndex = (currentIndex - 1 + totalImages) % totalImages;
        showImageAtIndex(currentIndex);
      });
    }
    if (nextBtn) {
      nextBtn.addEventListener('click', () => {
        currentIndex = (currentIndex + 1) % totalImages;
        showImageAtIndex(currentIndex);
      });
    }
  }

  function initAll() {
    const el = document.getElementById(id)
    
    initProductPage(el);
  }

  initAll();
})();


</script>

<script>
    import { addToCart } from "../../assets/cartStore";
import { listaProductos } from "../../assets/exports";

    // Inicializar carrito de compras
    function initializeCart() {
        
        const self = document.querySelector('product-page');
        const productId = parseInt(self?.getAttribute('data-product-id') || '0', 10);
        const producto = listaProductos.find(p => p.id == productId);
        if (!producto) return;
        const qtySelect = self?.querySelector('#cantidad') as HTMLSelectElement | null;
        const sizeInput = self?.querySelector('#selectedSize') as HTMLInputElement | null;
        const addToCartBtn = self?.querySelector('#addToCartBtn');
        
        addToCartBtn?.addEventListener('click', () => {
            
            const quantity = qtySelect ? parseInt(qtySelect.value, 10) : 1;
            const selectedSize = sizeInput ? sizeInput.value : '';
            if (addToCart(producto, quantity, selectedSize)) alert('Producto agregado al carrito');
            
        });
    }
    
    document.addEventListener('astro:before-swap', () => {
        // Limpia cualquier estado si es necesario antes de la navegación
    });
    document.addEventListener('astro:after-swap', () => {
        // Re-inicializa el estado después de la navegación
        initializeCart();
    });
    initializeCart();

    
    
</script>
