---
import { listaProductos, valorAPesosChilenos } from "../../assets/exports";
import Calificacion from "../../components/store/Calificacion.astro";
import Vitrina from "../../components/store/Vitrina.astro";
import Layout from "../../layouts/Layout.astro";

export const prerender = false;
const { id } = Astro.params;
const producto = listaProductos.find(p => p.id.toString() === id);
if (!producto) {
    Astro.response.status = 404;
    throw new Error(`Producto con id ${id} no encontrado.`);
}
---

<Layout title={producto.productName}>
    <section class="text-center">
        <h2 class="text-3xl font-bold" transition:name={`productName${id}`}>{producto.productName}</h2>
        <img src={producto.imageSrc} alt={`Imagen de ${producto.productName}`} class="w-64 h-64 object-cover mx-auto mt-4 rounded-md shadow-lg" transition:name={`productImage${id}`} />
        <div class="flex justify-end  w-5/6">
            <Calificacion estrellas={producto.stars} />
        </div>
        <div class="mt-4 bg-bg-200/20 w-5/6 mx-auto p-4 text-left rounded-md shadow whitespace-pre-wrap">
            {producto.description}
        </div>
        <div>
            <p class="mt-4 text-2xl font-semibold"
            transition:name={`productPrice${id}`}
            >Valor: {valorAPesosChilenos(producto.price)}</p>
        </div>
        <div class="w-5/6 text-left mx-auto mt-4 p-4">
            <p class="italic text-text-200">Stock disponible</p>
            <div class="flex justify-evenly items-center mt-3">
                <select name="cantidad" id="cantidad" class="border border-bg-300 rounded-md p-2 shadow-md hover:shadow-lg">
                    {Array.from({ length: producto.stock >= 10 ? 10 : producto.stock }, (_, i) => i + 1).map(cantidad => (
                        <option value={cantidad} >{cantidad} u.</option>
                    ))}
                </select>
                <p id="valorPorCantidad" class="">Total: <span id="valorSpan" class="text-lg font-black">{valorAPesosChilenos(producto.price)}</span></p>
            </div>
        </div>
        <div>
            <button class="mt-4 bg-primary-200 text-bg-100 py-2 px-4 rounded-md shadow hover:shadow-lg hover:scale-105 transition-transform active:scale-95 w-5/6 h-14 text-xl font-bold"
            transition:name={`addToCartButton${id}`}
            >
                Agregar al carro
            </button>
        </div>
        <div>
            <Vitrina filterId={id} horizontal compact/>
        </div>
    </section>
</Layout>
<script define:vars={{price: producto.price}} type="module">
    function valorAPesosChilenos(valor) {
        return new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' }).format(valor)
    }
    
    
    document.addEventListener('astro:page-load', () => {
        const selectCantidad = document.getElementById('cantidad');
        const valorSpan = document.getElementById('valorSpan');
    const precioUnitario = price;
        // Inicializar el valor al cargar la pÃ¡gina
        

        selectCantidad?.addEventListener('change', () => {
        const cantidadSeleccionada = parseInt(selectCantidad.value);
        const valorTotal = precioUnitario * cantidadSeleccionada;
        valorSpan.textContent = `${valorAPesosChilenos(valorTotal)}`;
    });
    });

    
</script>