---
interface Props {
    open?: boolean;
    closeOnBackdropClick?: boolean;
    ariaLabel?: string;
}

const { open = false, ariaLabel = 'Modal Dialog' } = Astro.props;
const modalId = `modal-${Math.random().toString(36).slice(2,9)}`;
---
<style>
    :root {
        --modal-bg: rgba(0,0,0,0.5);
        --panel-bg: #fff;
        --radius: 8px;
        --max-w: 32rem;
        --z: 9999;
    }

    .modal {
        position: relative;
        display: inline-block; /* allows trigger next to other content */
    }

    /* backdrop & panel are visually hidden when closed */
    .backdrop {
        position: fixed;
        inset: 0;
        background: var(--modal-bg);
        opacity: 0;
        pointer-events: none;
        transition: opacity .18s ease;
        z-index: var(--z);
    }

    .panel {
        position: fixed;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -48%) scale(.98);
        opacity: 0;
        max-width: calc(100% - 2rem);
        width: var(--max-w);
        border-radius: var(--radius);
        box-shadow: 0 10px 30px rgba(0,0,0,.18);
        padding: 1rem;
        transition: opacity .18s ease, transform .18s ease;
        z-index: -1;
        pointer-events: none;
    }

    .panel:focus {
        outline: none;
    }

    .is-open .backdrop {
        opacity: 1;
        pointer-events: auto;
    }

    .is-open .panel {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
        z-index: calc(var(--z) + 1);
        pointer-events: auto;
    }

    .close-btn {
        position: absolute;
        right: 0.5rem;
        top: 0.5rem;
        background: transparent;
        border: none;
        font-size: 1.25rem;
        line-height: 1;
        cursor: pointer;
    }

    /* Small utility: allow content scroll inside panel */
    .panel-content {
        max-height: calc(80vh);
        padding-top: 1.5rem;
    }
</style>

<div class="modal" id={modalId} data-open={open}>
    <div data-role="trigger-container" class="relative">
        <slot name="trigger"></slot>
        <p id="cartLength" class="sm:block absolute hidden -top-4 -right-5 text-bg-100 bg-primary-100 py-0.5 px-1.5 text-xs md:text-sm rounded-full font-bold "></p>
    </div>
    
    <div class="backdrop" data-role="backdrop" aria-hidden="true"></div>

    <div
        class="panel bg-bg-200"
        aria-role="dialog"
        aria-modal="true"
        aria-label={ariaLabel}
        data-role="panel"
        tabindex="-1"
    >
        <button class="close-btn" aria-label="Cerrar modal" data-role="close">✕</button>
        <div class="panel-content ">
            <slot name="content"></slot>
        </div>
    </div>
</div>

<script>
    function initialize () {
        const self = document.querySelector('.modal')
        if(!self) return
        const triggerContainer = self.querySelector('[data-role="trigger-container"]')
        const backdrop = self.querySelector('[data-role="backdrop"]')
        const panel = self.querySelector('[data-role="panel"]') as HTMLElement
        const closeBtn = self.querySelector('[data-role="close"]')
        const cartLength = self.querySelector('#cartLength')

        //Desabilitar si está en preOrder
        const url = new URL(document.URL)
        if (url.pathname == '/preOrder') {
            triggerContainer?.classList.add('pointer-events-none')
        } else {
            triggerContainer?.classList.remove('pointer-events-none')
        }
        
        
        let isOpen = Boolean(self.getAttribute('data-open')) && self.getAttribute('data-open') !== 'false';
        
        function setOpen(state: boolean) {
            isOpen = !!state;
            if (isOpen) {
                self?.classList.add('is-open');
                panel?.focus();
                document.documentElement.style.overflow = 'hidden';
            } else {
                self?.classList.remove('is-open');
                
                document.documentElement.style.overflow = '';
            }
        }
        setOpen(isOpen)

        triggerContainer?.addEventListener('click', () => setOpen(!isOpen))
        closeBtn?.addEventListener('click', () => setOpen(!isOpen))
        backdrop?.addEventListener('click' , () => setOpen(!isOpen))

        function setCartLength (v?: number) {
            if (!cartLength) return
            if (v) {
                cartLength.innerHTML = v.toString()
                cartLength.removeAttribute('hidden')
                
            }
            if (!v || v == 0) {
                cartLength.setAttribute('hidden', '')
            }
        }
        window.addEventListener('update-cartLength', (e: CustomEventInit) => {
            const newValue: number = e.detail?.cartLength
            
            if (!cartLength) return

            setCartLength(newValue)
            
        })
    }
    initialize()
    document.addEventListener('astro:after-swap', initialize)

    
</script>